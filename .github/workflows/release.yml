# This workflow is useful if you want to automate the process of:
#
# a) Creating a new prelease when you push a new tag with a "v" prefix (version).
#
#    This type of prerelease is meant to be used for production: alpha, beta, rc, etc. types of releases.
#    After the prerelease is created, you need to make your changes on the release page at the relevant
#    Github page and publish your release.
#
# b) Creating/updating the "latest" prerelease when you push to your default branch.
#
#    This type of prelease is useful to make your bleeding-edge binaries available to advanced users.
#
# The workflow will not run if there is no tag pushed with a "v" prefix and no change pushed to your
# default branch.
on: 
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build Binary
        run: |
          mkdir -p release
          # LDFLAGSì— ë²„ì „ì„ ì£¼ì…í•˜ëŠ” ê²ƒì€ ì½”ì–´ ê°œë°œì˜ ì •ì„ì…ë‹ˆë‹¤.
          VERSION=${{ github.ref_name }}
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then VERSION="latest"; fi
          
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags "-X github.com/cosmos/cosmos-sdk/version.Version=$VERSION" \
            -o release/topstard ./cmd/topstard/main.go

      - name: Package Assets
        run: |
          cd release
          tar -czvf topstar-linux-arm64.tar.gz topstard
          # ì²´í¬ì„¬ íŒŒì¼ ìƒì„± (ë³´ì•ˆ ë° ë¬´ê²°ì„± ì¦ëª… - í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì‚°ì )
          sha256sum topstar-linux-arm64.tar.gz > sha256sum.txt

      - name: Delete existing "latest" Release
        if: github.event_name == 'workflow_dispatch' || github.ref_name == 'main'
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          tag_name: latest
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name == 'main' && 'latest' || github.ref_name }}
          files: |
            release/topstar-linux-arm64.tar.gz
            release/sha256sum.txt
          prerelease: false # ì •ì‹ ë¦´ë¦¬ìŠ¤ë¡œ ì„¤ì •í•˜ì—¬ latest íƒœê·¸ í™œì„±í™”
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # ë°°í¬ ì¡ìœ¼ë¡œ íŒŒì¼ì„ ì „ë‹¬í•˜ê¸° ìœ„í•´ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ì¶”ê°€
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: topstar-binary
          path: release/topstar-linux-arm64.tar.gz


  init-master:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: topstar-binary

      - name: Initialize Master Genesis (Server 1)
        run: |
          IP=${{ secrets.SERVER_1_IP }}
          USER=${{ secrets.REMOTE_USER }}
          ssh -o StrictHostKeyChecking=no $USER@$IP "mkdir -p ~/deploy"
          scp -o StrictHostKeyChecking=no topstar-linux-arm64.tar.gz $USER@$IP:~/deploy/
          
          ssh -o StrictHostKeyChecking=no $USER@$IP << 'EOF'
            cd ~/deploy
            tar -xzf topstar-linux-arm64.tar.gz && chmod +x topstard
            
            # 1. ì´ˆê¸°í™” (ë§¤ ë°°í¬ë§ˆë‹¤ ê¹¨ë—í•˜ê²Œ ë¦¬ì…‹í•˜ì—¬ ë³€ê²½ì‚¬í•­ ë°˜ì˜)
            rm -rf ~/.topstar/
            ./topstard init node-01 --chain-id topstar-testnet-1
              
              # 2. ìœ íš¨í•œ ë‹ˆëª¨ë‹‰ìœ¼ë¡œ ì§€ê°‘ ë³µêµ¬ (ëŒ€ì‹œë³´ë“œì™€ ë™ì¼í•œ ë‹ˆëª¨ë‹‰ ì‚¬ìš©)
              echo "duty cricket season pair core apology lava announce liberty prison flip viable assist cook armor blind strong agree online phone fold shaft heavy slow" | ./topstard keys add alice --recover --keyring-backend test
              echo "media cluster angry because size athlete wrist advice couch room border angle response whip bless fruit canvas iron jaguar craft virtual gold member today" | ./topstard keys add bob --recover --keyring-backend test
              
              # 3. ì œë„¤ì‹œìŠ¤ ê³„ì • ì„¤ì • (ì¶©ë¶„í•œ ìê¸ˆ í• ë‹¹)
              ./topstard genesis add-genesis-account alice 1000000000stake,2000000umytoken --keyring-backend test
              ./topstard genesis add-genesis-account bob 1000000stake,1000000umytoken --keyring-backend test
              
              # 4. ê²€ì¦ì¸ ì„ ì–¸ (Gentx)
              ./topstard genesis gentx alice 100000000stake --chain-id topstar-testnet-1 --keyring-backend test
              
              # 5. ìˆ˜ì§‘
              ./topstard genesis collect-gentxs
            # fi (ë°ì´í„° ë¦¬ì…‹ì„ ìœ„í•´ ifë¬¸ ì œê±°)
          EOF
          
          # 6. ì„œë²„ 1ë²ˆì˜ Node ID ì¶”ì¶œ
          NODE_ID=$(ssh -o StrictHostKeyChecking=no $USER@$IP "~/deploy/topstard tendermint show-node-id")
          echo "$NODE_ID@$IP:26656" > master_peer.txt
          
          scp -o StrictHostKeyChecking=no $USER@$IP:~/.topstar/config/genesis.json ./master_genesis.json




      - name: Upload Master Info (Genesis & Peer)
        uses: actions/upload-artifact@v4
        with:
          name: master-info
          path: |
            master_genesis.json
            master_peer.txt

  deploy-nodes:
    needs: [release, init-master]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        server_id: [1, 2, 3]
    steps:
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary

      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: topstar-binary

      - name: Download Master Info
        uses: actions/download-artifact@v4
        with:
          name: master-info

      - name: Deploy and Sync
        run: |
          IP=${{ secrets[format('SERVER_{0}_IP', matrix.server_id)] }}
          USER=${{ secrets.REMOTE_USER }}
          MASTER_PEER=$(cat master_peer.txt)
          
          echo "ğŸš€ Deploying to $IP..."
          ssh -o StrictHostKeyChecking=no $USER@$IP "mkdir -p ~/deploy"
          scp -o StrictHostKeyChecking=no topstar-linux-arm64.tar.gz $USER@$IP:~/deploy/
          
          # 1. ë°”ì´ë„ˆë¦¬ êµì²´ ë° ì´ˆê¸°í™” (ë¦¬ì…‹)
          ssh -o StrictHostKeyChecking=no $USER@$IP << 'EOF'
            cd ~/deploy
            tar -xzvf topstar-linux-arm64.tar.gz
            chmod +x topstard
            
            # ê¸°ì¡´ ë°ì´í„° ì‚­ì œ (ë§ˆìŠ¤í„°ì™€ ë™ê¸°í™”ë¥¼ ìœ„í•´)
            rm -rf ~/.topstar/
            ./topstard init "node-${{ matrix.server_id }}" --chain-id topstar-testnet-1
          EOF

          # 2. ë§ˆìŠ¤í„° ì œë„¤ì‹œìŠ¤ ì£¼ì…
          scp -o StrictHostKeyChecking=no ./master_genesis.json $USER@$IP:~/.topstar/config/genesis.json
          
          # 3. ì„¤ì • ìµœì í™” (P2P, RPC, API, CORS)
          ssh -o StrictHostKeyChecking=no $USER@$IP << EOF
            CONFIG_PATH="\$HOME/.topstar/config/config.toml"
            APP_PATH="\$HOME/.topstar/config/app.toml"
            
            # P2P ì—°ê²° (Master Peer)
            if [ "${{ matrix.server_id }}" != "1" ]; then
              sed -i 's/^persistent_peers = .*/persistent_peers = "$MASTER_PEER"/' \$CONFIG_PATH
            fi
            
            # RPC & CORS ê°œë°©
            sed -i 's|^laddr = "tcp://127.0.0.1:26657"|laddr = "tcp://0.0.0.0:26657"|' \$CONFIG_PATH
            sed -i 's|cors_allowed_origins = .*|cors_allowed_origins = ["*"]|' \$CONFIG_PATH
            
            # API í™œì„±í™” & CORS & gRPC ì—°ë™ (ê³µë°± ë°©ì–´ë§‰ ì œê±°)
            sed -i '/\[api\]/,/^\[/ s/^[[:space:]]*enable = false/enable = true/' \$APP_PATH
            sed -i 's|^address = "tcp://localhost:1317"|address = "tcp://0.0.0.0:1317"|' \$APP_PATH
            sed -i 's/^[[:space:]]*enabled-unsafe-cors = .*/enabled-unsafe-cors = true/' \$APP_PATH
            
            # gRPC ë‚´ë¶€ í†µì‹ ìš© ê°œë°© (500 ì—ëŸ¬ ë°©ì§€)
            sed -i '/\[grpc\]/,/^\[/ s/^[[:space:]]*enable = false/enable = true/' \$APP_PATH
            sed -i '/\[grpc\]/,/^\[/ s/^[[:space:]]*address = "localhost:9090"/address = "0.0.0.0:9090"/' \$APP_PATH
          EOF

          # 4. ë°©í™”ë²½ ì„¤ì • (OCI ì „ìš©)
          ssh -o StrictHostKeyChecking=no $USER@$IP << 'EOF'
            sudo iptables -I INPUT 1 -p tcp --dport 26656 -j ACCEPT
            sudo iptables -I INPUT 1 -p tcp --dport 26657 -j ACCEPT
            sudo iptables -I INPUT 1 -p tcp --dport 1317 -j ACCEPT
            sudo iptables -I INPUT 1 -p tcp --dport 9090 -j ACCEPT
            sudo netfilter-persistent save 2>/dev/null || true
          EOF

          # 5. systemd ì„œë¹„ìŠ¤ ìƒì‹œ ê°€ë™ ì„¤ì •
          ssh -o StrictHostKeyChecking=no $USER@$IP << 'EOF'
            USER_NAME=$(whoami)
            sudo printf "[Unit]\nDescription=Topstar Node\nAfter=network-online.target\n\n[Service]\nUser=%s\nExecStart=/home/%s/deploy/topstard start --minimum-gas-prices=0stake\nRestart=always\nRestartSec=3\nLimitNOFILE=4096\n\n[Install]\nWantedBy=multi-user.target\n" "$USER_NAME" "$USER_NAME" | sudo tee /etc/systemd/system/topstard.service > /dev/null
            sudo systemctl daemon-reload
            sudo systemctl enable topstard
            sudo systemctl restart topstard
            echo "âœ… Node is now running under systemd"
          EOF

  update-dashboard:
    needs: deploy-nodes
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: dashboard/package.json

      - name: Install Dependencies
        run: |
          cd dashboard
          npm install

      - name: Build Dashboard
        env:
          VITE_RPC_URL: http://${{ secrets.SERVER_1_IP }}:26657
          VITE_API_URL: http://${{ secrets.SERVER_1_IP }}:1317
          VITE_NODE1_URL: http://${{ secrets.SERVER_1_IP }}:26657
          VITE_NODE2_URL: http://${{ secrets.SERVER_2_IP }}:26657
          VITE_NODE3_URL: http://${{ secrets.SERVER_3_IP }}:26657
        run: |
          cd dashboard
          npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dashboard/dist
          publish_branch: gh-pages











