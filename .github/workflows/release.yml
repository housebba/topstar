# This workflow is useful if you want to automate the process of:
#
# a) Creating a new prelease when you push a new tag with a "v" prefix (version).
#
#    This type of prerelease is meant to be used for production: alpha, beta, rc, etc. types of releases.
#    After the prerelease is created, you need to make your changes on the release page at the relevant
#    Github page and publish your release.
#
# b) Creating/updating the "latest" prerelease when you push to your default branch.
#
#    This type of prelease is useful to make your bleeding-edge binaries available to advanced users.
#
# The workflow will not run if there is no tag pushed with a "v" prefix and no change pushed to your
# default branch.
on: 
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build Binary
        run: |
          mkdir -p release
          # LDFLAGSì— ë²„ì „ì„ ì£¼ì…í•˜ëŠ” ê²ƒì€ ì½”ì–´ ê°œë°œì˜ ì •ì„ì…ë‹ˆë‹¤.
          VERSION=${{ github.ref_name }}
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then VERSION="latest"; fi
          
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags "-X github.com/cosmos/cosmos-sdk/version.Version=$VERSION" \
            -o release/topstard ./cmd/topstard/main.go

      - name: Package Assets
        run: |
          cd release
          tar -czvf topstar-linux-arm64.tar.gz topstard
          # ì²´í¬ì„¬ íŒŒì¼ ìƒì„± (ë³´ì•ˆ ë° ë¬´ê²°ì„± ì¦ëª… - í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì‚°ì )
          sha256sum topstar-linux-arm64.tar.gz > sha256sum.txt

      - name: Delete existing "latest" Release
        if: github.event_name == 'workflow_dispatch' || github.ref_name == 'main'
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          tag_name: latest
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name == 'main' && 'latest' || github.ref_name }}
          files: |
            release/topstar-linux-arm64.tar.gz
            release/sha256sum.txt
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ë°°í¬ ì¡ìœ¼ë¡œ íŒŒì¼ì„ ì „ë‹¬í•˜ê¸° ìœ„í•´ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ì¶”ê°€
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: topstar-binary
          path: release/topstar-linux-arm64.tar.gz


  deploy:
    needs: release
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # í•œ ì„œë²„ê°€ ì‹¤íŒ¨í•´ë„ ë‚˜ë¨¸ì§€ëŠ” ê³„ì† ì§„í–‰
      matrix:
        server_id: [1, 2, 3]
    steps:
      - name: Deploy to Server via SSH + Curl
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets[format('SERVER_{1}_IP', '', matrix.server_id)] }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p ~/deploy
            cd ~/deploy
            
            # 1. ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ë° GitHub Releaseì—ì„œ ì§ì ‘ ë‹¤ìš´ë¡œë“œ (ì´ˆê³ ì†)
            # Authorization í—¤ë”ë¥¼ ë„£ì–´ í”„ë¼ì´ë¹— ë ˆí¬ì¸ ê²½ìš°ì—ë„ ì‘ë™í•˜ê²Œ í•©ë‹ˆë‹¤.
            # latest íƒœê·¸ì˜ íŒŒì¼ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
            rm -f topstar-linux-arm64.tar.gz
            curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -O https://github.com/${{ github.repository }}/releases/download/latest/topstar-linux-arm64.tar.gz
            
            # 2. ì••ì¶• í•´ì œ ë° ê¶Œí•œ ë¶€ì—¬
            tar -xzvf topstar-linux-arm64.tar.gz
            chmod +x topstard
            
            # 3. ë…¸ë“œ ì„¤ì • ë° ë²„ì „ í™•ì¸
            if [ ! -f ~/.topstar/config/genesis.json ]; then
              ./topstard init "node-${{ matrix.server_id }}" --chain-id topstar-1
            fi
            
            ./topstard version
            echo "ğŸš€ Server ${{ matrix.server_id }} ë°°í¬ ì„±ê³µ!"





