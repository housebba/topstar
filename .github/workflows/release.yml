# This workflow is useful if you want to automate the process of:
#
# a) Creating a new prelease when you push a new tag with a "v" prefix (version).
#
#    This type of prerelease is meant to be used for production: alpha, beta, rc, etc. types of releases.
#    After the prerelease is created, you need to make your changes on the release page at the relevant
#    Github page and publish your release.
#
# b) Creating/updating the "latest" prerelease when you push to your default branch.
#
#    This type of prelease is useful to make your bleeding-edge binaries available to advanced users.
#
# The workflow will not run if there is no tag pushed with a "v" prefix and no change pushed to your
# default branch.
on: 
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build Binary
        run: |
          mkdir -p release
          # LDFLAGS에 버전을 주입하는 것은 코어 개발의 정석입니다.
          VERSION=${{ github.ref_name }}
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then VERSION="latest"; fi
          
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags "-X github.com/cosmos/cosmos-sdk/version.Version=$VERSION" \
            -o release/topstard ./cmd/topstard/main.go

      - name: Package Assets
        run: |
          cd release
          tar -czvf topstar-linux-arm64.tar.gz topstard
          # 체크섬 파일 생성 (보안 및 무결성 증명 - 포트폴리오 가산점)
          sha256sum topstar-linux-arm64.tar.gz > sha256sum.txt

      - name: Delete existing "latest" Release
        if: github.event_name == 'workflow_dispatch' || github.ref_name == 'main'
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          tag_name: latest
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name == 'main' && 'latest' || github.ref_name }}
          files: |
            release/topstar-linux-arm64.tar.gz
            release/sha256sum.txt
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: release
    if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    strategy:
      matrix:
        server_id: [1, 2, 3] # IP 대신 인덱스를 사용
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Asset from Release
        uses: dsaltares/fetch-gh-release-asset@master
        with:
          version: 'latest'
          file: 'topstar-linux-arm64.tar.gz'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Deploy Directory via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets[format('SERVER_{1}_IP', '', matrix.server_id)] }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: mkdir -p ~/deploy

      - name: Copy Binary to Servers via SCP
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets[format('SERVER_{1}_IP', '', matrix.server_id)] }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "topstar-linux-arm64.tar.gz"
          target: "deploy"


      - name: Exec Deploy Script via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets[format('SERVER_{1}_IP', '', matrix.server_id)] }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            mkdir -p ~/deploy
            cd ~/deploy
            tar -xzvf topstar-linux-arm64.tar.gz
            chmod +x topstard
            
            # 노드가 설치되어 있는지 확인 후 초기화 (필요시)
            if [ ! -f ~/.topstar/config/genesis.json ]; then
              ./topstard init "node-${{ matrix.server_id }}" --chain-id topstar-1
            fi
            
            ./topstard version




