# This workflow is useful if you want to automate the process of:
#
# a) Creating a new prelease when you push a new tag with a "v" prefix (version).
#
#    This type of prerelease is meant to be used for production: alpha, beta, rc, etc. types of releases.
#    After the prerelease is created, you need to make your changes on the release page at the relevant
#    Github page and publish your release.
#
# b) Creating/updating the "latest" prerelease when you push to your default branch.
#
#    This type of prelease is useful to make your bleeding-edge binaries available to advanced users.
#
# The workflow will not run if there is no tag pushed with a "v" prefix and no change pushed to your
# default branch.
on: 
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Build Binary
        run: |
          mkdir -p release
          # LDFLAGSì— ë²„ì „ì„ ì£¼ì…í•˜ëŠ” ê²ƒì€ ì½”ì–´ ê°œë°œì˜ ì •ì„ì…ë‹ˆë‹¤.
          VERSION=${{ github.ref_name }}
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then VERSION="latest"; fi
          
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 go build \
            -ldflags "-X github.com/cosmos/cosmos-sdk/version.Version=$VERSION" \
            -o release/topstard ./cmd/topstard/main.go

      - name: Package Assets
        run: |
          cd release
          tar -czvf topstar-linux-arm64.tar.gz topstard
          # ì²´í¬ì„¬ íŒŒì¼ ìƒì„± (ë³´ì•ˆ ë° ë¬´ê²°ì„± ì¦ëª… - í¬íŠ¸í´ë¦¬ì˜¤ ê°€ì‚°ì )
          sha256sum topstar-linux-arm64.tar.gz > sha256sum.txt

      - name: Delete existing "latest" Release
        if: github.event_name == 'workflow_dispatch' || github.ref_name == 'main'
        uses: dev-drprasad/delete-tag-and-release@v0.2.1
        with:
          tag_name: latest
          delete_release: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name == 'main' && 'latest' || github.ref_name }}
          files: |
            release/topstar-linux-arm64.tar.gz
            release/sha256sum.txt
          prerelease: false # ì •ì‹ ë¦´ë¦¬ìŠ¤ë¡œ ì„¤ì •í•˜ì—¬ latest íƒœê·¸ í™œì„±í™”
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # ë°°í¬ ì¡ìœ¼ë¡œ íŒŒì¼ì„ ì „ë‹¬í•˜ê¸° ìœ„í•´ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ì¶”ê°€
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: topstar-binary
          path: release/topstar-linux-arm64.tar.gz


  init-master:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: topstar-binary

      - name: Initialize Master Genesis (Server 1)
        run: |
          IP=${{ secrets.SERVER_1_IP }}
          USER=${{ secrets.REMOTE_USER }}
          ssh -o StrictHostKeyChecking=no $USER@$IP "mkdir -p ~/deploy"
          scp -o StrictHostKeyChecking=no topstar-linux-arm64.tar.gz $USER@$IP:~/deploy/
          ssh -o StrictHostKeyChecking=no $USER@$IP "cd ~/deploy && tar -xzf topstar-linux-arm64.tar.gz && chmod +x topstard"
          ssh -o StrictHostKeyChecking=no $USER@$IP "~/deploy/topstard init node-01 --chain-id topstar-testnet-1 -o"
          scp -o StrictHostKeyChecking=no $USER@$IP:~/.topstar/config/genesis.json ./master_genesis.json

      - name: Upload Master Genesis
        uses: actions/upload-artifact@v4
        with:
          name: master-genesis
          path: master_genesis.json

  deploy-nodes:
    needs: [release, init-master]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        server_id: [1, 2, 3]
    steps:
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: unnecessary

      - name: Download Binary
        uses: actions/download-artifact@v4
        with:
          name: topstar-binary

      - name: Download Master Genesis
        uses: actions/download-artifact@v4
        with:
          name: master-genesis

      - name: Deploy and Sync
        run: |
          IP=${{ secrets[format('SERVER_{1}_IP', '', matrix.server_id)] }}
          USER=${{ secrets.REMOTE_USER }}
          
          echo "ğŸš€ Deploying to $IP..."
          ssh -o StrictHostKeyChecking=no $USER@$IP "mkdir -p ~/deploy"
          scp -o StrictHostKeyChecking=no topstar-linux-arm64.tar.gz $USER@$IP:~/deploy/
          
          # 1. ì´ˆê¸°í™” ë° ë°”ì´ë„ˆë¦¬ êµì²´
          ssh -o StrictHostKeyChecking=no $USER@$IP << 'EOF'
            cd ~/deploy
            tar -xzvf topstar-linux-arm64.tar.gz
            chmod +x topstard
            ./topstard init "node-${{ matrix.server_id }}" --chain-id topstar-testnet-1 -o
          EOF

          # 2. ë§ˆìŠ¤í„° ì œë„¤ì‹œìŠ¤ ì£¼ì… (ëª¨ë“  ë…¸ë“œê°€ ë™ì¼í•œ ì œë„¤ì‹œìŠ¤ë¥¼ ê°–ê²Œ í•¨)
          scp -o StrictHostKeyChecking=no ./master_genesis.json $USER@$IP:~/.topstar/config/genesis.json
          
          ssh -o StrictHostKeyChecking=no $USER@$IP "~/deploy/topstard version && echo 'âœ… Deployment & Genesis Sync Successful!'"









